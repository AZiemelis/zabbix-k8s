- hosts: k8s
  connection: local
  tasks:
    - name: Apply namespace manifests
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('file', '../k8s/base/namespace.yml') | from_yaml_all }}"

    - name: Apply configmap and secret manifests
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('file', item) | from_yaml_all }}"
      loop:
        - ../k8s/base/configmap.yml
        - ../k8s/base/secrets.yml

    - name: Setup PostgreSQL
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('file', '../k8s/db/postgres.yml') | from_yaml_all }}"

    - name: Setup Zabbix
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('file', item) | from_yaml_all }}"
      loop:
        - ../k8s/zabbix/zabbix-frontend.yml
        - ../k8s/zabbix/zabbix-server.yml

    - name: Setup SNMP network environment
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('file', item) | from_yaml_all }}"
      loop:
        - ../k8s/snmp/snmp-configmap.yml
        - ../k8s/snmp/zabbix-proxy.yml

    - name: Set credentials to access Zabbix Server API
      ansible.builtin.set_fact:
        ansible_host: "localhost"
        ansible_user: "Admin"
        ansible_httpapi_pass: "zabbix"
        ansible_network_os: "community.zabbix.zabbix"
        ansible_connection: "httpapi"
        ansible_httpapi_port: "80"
        ansible_zabbix_url_path: ""

    - name: Add proxy to Zabbix Server
      community.zabbix.zabbix_proxy:
        proxy_name: "zabbix-proxy.monitoring.svc"
        operating_mode: active
        state: present

    - name: Add Zabbix proxy host
      community.zabbix.zabbix_host:
        host_name: "zabbix-proxy.monitoring.svc"
        host_groups:
          - "Zabbix servers"
        link_templates:
          - "Linux by Zabbix agent"
        state: present
        monitored_by: proxy
        proxy: zabbix-proxy.monitoring.svc
        inventory_mode: disabled
        interfaces:
          - ip: "127.0.0.1"
            port: "10050"
            type: "1"
            useip: "1"
            main: "1"

    - name: Add SNMP Hosts
      community.zabbix.zabbix_host:
        host_name: snmp_device_{{ item }}
        host_groups:
          - Discovered hosts
        link_templates:
          - Linux by SNMP
        state: present
        monitored_by: proxy
        proxy: zabbix-proxy.monitoring.svc
        interfaces:
          - ip: 127.0.0.1
            main: 1
            port: "{{ item }}"
            type: "snmp"
            useip: 1
            details:
              community: "public"
      loop:
        - 30161
        - 30162
        - 30163

    - name: Add "SNMP hosts not active" trigger action
      become: false
      community.zabbix.zabbix_action:
        name: "SNMP hosts not active"
        event_source: "trigger"
        state: present
        esc_period: 60
        conditions:
          - type: "trigger_severity"
            operator: ">="
            value: "warning"
          - type: "trigger"
            operator: "="
            value: "Linux: Unavailable by ICMP ping"
          - type: "trigger"
            operator: "="
            value: "Linux: No SNMP data collection"
          - type: "trigger"
            operator: "="
            value: "Linux: Load average is too high"
          - type: "trigger"
            operator: "="
            value: "Linux: Lack of available memory"
          - type: "trigger"
            operator: "="
            value: "Linux: High ICMP ping loss"
        operations:
          - type: "send_message"
            subject: "Zabbix SNMP Host Alert: Connectivity or Performance Issue"
            op_message: |
              One or more Zabbix SNMP hosts are reporting problems.

              Host: {HOST.NAME}
              Problem: {TRIGGER.NAME}
              Severity: {TRIGGER.SEVERITY}
              Time: {EVENT.DATE} {EVENT.TIME}

              Please verify connectivity and investigate the issue.
            media_type: "all"
            send_to_users:
              - "Admin"
            send_to_groups:
              - "Zabbix administrators"